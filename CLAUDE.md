# Инструкция для Claude Code

## Рабочий процесс

### После завершения задачи — ВСЕГДА:
1. **Запустить билд** — `npm run build` для проверки ошибок
2. **Закоммитить в git** — без напоминания пользователя
3. **Запушить в git** — `git push` сразу после коммита

### Git workflow:
```bash
git status
git add <files>
git commit -m "feat/fix: описание"
git push
```

### Формат коммитов:
- `feat:` — новая функциональность
- `fix:` — исправление бага
- `refactor:` — рефакторинг без изменения поведения
- Коммит на русском языке (проект на русском    )

## Архитектура проекта

### Разделение ответственности:
| Сущность | Что определяет |
|----------|----------------|
| **Лампа (lamp.level)** | Веса редкостей (какие могут выпасть) |
| **Данж (dungeon.chapter)** | Уровень предмета → базовые статы |
| **Редкость (rarity)** | Множитель к базовым статам |

### Конфигурационные файлы (data/):
- `rarities.json` — 7 редкостей с цветами и множителями
- `lamp-levels.json` — 31 уровень лампы с весами редкостей
- `items.json` — basePowerPerLevel, levelRange, slotRatios
- `enemies.json` — прогрессия врагов, волны, босс, статы
- `balance.json` — combat, economy

### Формула силы предмета:
```
targetPower = basePowerPerLevel * 1.5^(itemLevel-1) * rarityMultiplier
```
- `itemLevel` = `random(dungeonChapter - minLevelOffset, dungeonChapter)`
- `basePowerPerLevel` = из items.json
- `1.5` = множитель роста за уровень (+50%)
- `rarityMultiplier` = из rarities.json

## Документация формул

**ВАЖНО:** Все формулы баланса хранятся в `FORMULAS.md`.
При изменении/добавлении формул — обновлять этот файл!

## Частые ошибки (не забывать!)

1. **Не забывать пушить в git** после коммита
2. **Проверять билд** перед коммитом
3. **Сбрасывать localStorage** при изменении структуры данных (напомнить пользователю)
4. **Обновлять FORMULAS.md** при изменении формул баланса
5. **Синхронизировать логику игры и тестера** — при изменении механик (лут, бой, прогрессия) обновлять ОБА места:
   - `src/systems/GameState.ts` — игровая логика
   - `src/testing/EconomyTester.ts` — симуляция для тестов

## Команды

```bash
npm run dev           # Запуск dev сервера
npm run build         # Сборка для продакшена
npm run test:economy  # Тест экономики (CLI)
git push              # Деплой на GitHub Pages
```

## Тестирование экономики

**Запуск:** `npm run test:economy`

**ВАЖНО:** При пересчёте симуляции — ВСЕГДА коммитить и пушить результаты!
CSV-файлы в `public/` нужны для графиков на GitHub Pages.

Тестер симулирует прохождение игры:
1. Лутает пока `heroPower < enemyPower`
2. После поражения — обязательно 1 лут перед сравнением сил
3. Апгрейдит лампу когда есть золото
4. Бьётся, при поражении возвращается к луту
5. Записывает метрики по главам

**Результат:**
- Таблица в консоли (Loots, Battles, Defeats, Power vs Enemy)
- CSV в `output/economy_test.csv` для графиков

**Файлы тестера:**
- `src/testing/EconomyTester.ts` — основная логика
- `src/testing/TestMetrics.ts` — интерфейсы
- `src/testing/runTest.ts` — CLI скрипт

**При изменении баланса** — прогнать `npm run test:economy` и проверить:
- Сколько лутов нужно на главу
- Соотношение Power vs Enemy
- Количество поражений

## Тестовое окружение

**Пользователь тестирует на GitHub Pages:**
https://labetski-b.github.io/Cult.BattleSystem/

### Если "не работает" — проверить:
1. **Изменения закоммичены?** — `git status`
2. **Изменения запушены?** — `git log --oneline -1` vs GitHub
3. **Деплой завершён?** — ~1 минута после push

> JSON-файлы инлайнятся при билде (Vite), поэтому кэш браузера не причём.
> Проблема почти всегда в незапушенных изменениях.
