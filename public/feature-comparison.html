<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Comparison</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            margin: 0;
        }
        h1, h2, h3, h4 { color: #ffd700; margin-bottom: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Controls Panel */
        .controls-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            background: #2a2a4e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .control-group {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
        }
        .control-group h3 {
            margin-top: 0;
            font-size: 14px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .control-row label {
            flex: 1;
            font-size: 12px;
            color: #aaa;
        }
        .control-row input[type="number"] {
            width: 70px;
            background: #333;
            border: 1px solid #555;
            color: #eee;
            padding: 4px;
            border-radius: 4px;
            text-align: right;
        }
        .control-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Buttons */
        .buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        .btn-primary {
            background: #ffd700;
            color: #1a1a2e;
            font-weight: bold;
        }
        .btn-primary:hover { background: #ffed4a; }

        /* Status */
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-running { background: #444422; color: #ffd700; }
        .status-done { background: #224422; color: #6bff6b; }
        .status-error { background: #442222; color: #ff6b6b; }

        /* Layers Container */
        #layers-container {
            margin-top: 20px;
        }

        /* Layer */
        .layer {
            background: #2a2a4e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .layer h3 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        /* Charts Row */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Container */
        .chart-container {
            position: relative;
        }
        .chart-container h4 {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
        }
        .chart-scroll {
            overflow-x: auto;
            max-width: 100%;
        }

        /* Canvas */
        canvas {
            background: #1a1a2e;
            border-radius: 8px;
        }

        /* Summary in layer */
        .layer-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .summary-item {
            background: #1a1a2e;
            padding: 8px 12px;
            border-radius: 4px;
            text-align: center;
        }
        .summary-value {
            font-size: 18px;
            color: #ffd700;
            font-weight: bold;
        }
        .summary-label {
            font-size: 10px;
            color: #888;
        }
        .summary-diff {
            font-size: 10px;
            margin-left: 4px;
        }
        .diff-positive { color: #ff6b6b; }
        .diff-negative { color: #6bff6b; }

        .info-text {
            font-size: 11px;
            color: #666;
            margin: 5px 0 0 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Feature Comparison</h1>
        <p style="color: #888; margin-bottom: 20px;">Независимые симуляторы для сравнения фич</p>

        <!-- Controls -->
        <div class="controls-panel">
            <!-- Common Settings -->
            <div class="control-group">
                <h3>Simulation</h3>
                <div class="control-row">
                    <label>Max Chapters</label>
                    <input type="number" id="maxChapters" value="30" min="1" max="100">
                </div>
                <div class="control-row">
                    <label>Runs (avg)</label>
                    <input type="number" id="simRuns" value="1" min="1" max="100">
                </div>
            </div>

            <!-- Simulators Selection -->
            <div class="control-group">
                <h3>Simulators</h3>
                <div class="control-row">
                    <label>V0: Baseline</label>
                    <input type="checkbox" id="sim-baseline" checked disabled>
                </div>
                <div class="control-row">
                    <label>V1: + Item Level Range</label>
                    <input type="checkbox" id="sim-itemLevelRange" checked>
                </div>
                <div class="control-row">
                    <label>V2: + Guaranteed Rarity</label>
                    <input type="checkbox" id="sim-guaranteedRarity" checked>
                </div>
                <div class="control-row">
                    <label>V3: + Power Variance</label>
                    <input type="checkbox" id="sim-powerVariance" checked>
                </div>
                <div class="control-row">
                    <label>V4: + Guaranteed Upgrade</label>
                    <input type="checkbox" id="sim-guaranteedUpgrade" checked>
                </div>
                <p class="info-text">Каждый симулятор — независимая копия логики</p>
            </div>

            <!-- Display Options -->
            <div class="control-group">
                <h3>Display Options</h3>
                <div class="control-row">
                    <label>Show Rarity Bar</label>
                    <input type="checkbox" id="showRarity" checked>
                </div>
                <p class="info-text">Полоска редкости на графике Loots per Chapter</p>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-primary" onclick="runComparison()">Run Comparison</button>
        </div>

        <div id="status"></div>

        <!-- Layers will be generated dynamically -->
        <div id="layers-container"></div>
    </div>

    <script type="module">
        import {
            BaselineSimulator,
            ItemLevelRangeSimulator,
            GuaranteedRaritySimulator,
            PowerVarianceSimulator,
            GuaranteedUpgradeSimulator
        } from '../src/testing/comparison/index.ts';

        const RARITY_COLORS = {
            common: '#9ca3af',
            good: '#22c55e',
            rare: '#3b82f6',
            epic: '#a855f7',
            mythic: '#f43f5e',
            legendary: '#f59e0b',
            immortal: '#fbbf24'
        };

        // Simulator definitions
        const SIMULATORS = [
            {
                id: 'baseline',
                name: 'V0: Baseline',
                class: BaselineSimulator,
                isEnabled: () => true  // Always enabled
            },
            {
                id: 'itemLevelRange',
                name: 'V1: + Item Level Range',
                class: ItemLevelRangeSimulator,
                isEnabled: () => document.getElementById('sim-itemLevelRange').checked
            },
            {
                id: 'guaranteedRarity',
                name: 'V2: + Guaranteed Rarity',
                class: GuaranteedRaritySimulator,
                isEnabled: () => document.getElementById('sim-guaranteedRarity').checked
            },
            {
                id: 'powerVariance',
                name: 'V3: + Power Variance',
                class: PowerVarianceSimulator,
                isEnabled: () => document.getElementById('sim-powerVariance').checked
            },
            {
                id: 'guaranteedUpgrade',
                name: 'V4: + Guaranteed Upgrade',
                class: GuaranteedUpgradeSimulator,
                isEnabled: () => document.getElementById('sim-guaranteedUpgrade').checked
            }
        ];

        // Run comparison
        window.runComparison = async function() {
            const status = document.getElementById('status');
            status.textContent = 'Running simulations...';
            status.className = 'status-running';

            const maxChapters = parseInt(document.getElementById('maxChapters').value);
            const numRuns = parseInt(document.getElementById('simRuns').value);

            try {
                const results = [];

                for (const sim of SIMULATORS) {
                    if (!sim.isEnabled()) continue;

                    status.textContent = `Running ${sim.name}...`;

                    const summary = runMultipleSimulations(sim.class, maxChapters, numRuns);
                    results.push({
                        name: sim.name,
                        summary: summary
                    });
                }

                // Render results
                renderLayers(results);

                status.textContent = `Done! ${results.length} simulators completed.`;
                status.className = 'status-done';
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.className = 'status-error';
                console.error(error);
            }
        };

        function runMultipleSimulations(SimulatorClass, maxChapters, numRuns) {
            if (numRuns === 1) {
                const sim = new SimulatorClass({ maxChapters });
                return sim.run();
            }

            const summaries = [];
            for (let i = 0; i < numRuns; i++) {
                const sim = new SimulatorClass({ maxChapters });
                summaries.push(sim.run());
            }
            return averageSummaries(summaries);
        }

        function averageSummaries(summaries) {
            const n = summaries.length;
            const first = summaries[0];

            const avg = {
                totalChapters: first.totalChapters,
                totalLoots: Math.round(summaries.reduce((s, x) => s + x.totalLoots, 0) / n),
                totalBattles: Math.round(summaries.reduce((s, x) => s + x.totalBattles, 0) / n),
                totalDefeats: Math.round(summaries.reduce((s, x) => s + x.totalDefeats, 0) / n),
                totalUnfairDefeats: Math.round(summaries.reduce((s, x) => s + x.totalUnfairDefeats, 0) / n),
                totalGoldEarned: Math.round(summaries.reduce((s, x) => s + x.totalGoldEarned, 0) / n),
                totalGoldSpent: Math.round(summaries.reduce((s, x) => s + x.totalGoldSpent, 0) / n),
                finalLampLevel: Math.round(summaries.reduce((s, x) => s + x.finalLampLevel, 0) / n),
                finalHeroPower: Math.round(summaries.reduce((s, x) => s + x.finalHeroPower, 0) / n),
                finalHeroLevel: first.finalHeroLevel,
                chapters: first.chapters.map((ch, i) => ({
                    ...ch,
                    loots: Math.round(summaries.reduce((s, x) => s + x.chapters[i].loots, 0) / n),
                    battles: Math.round(summaries.reduce((s, x) => s + x.chapters[i].battles, 0) / n),
                    defeats: Math.round(summaries.reduce((s, x) => s + x.chapters[i].defeats, 0) / n)
                })),
                stages: first.stages.map((st, i) => ({
                    ...st,
                    loots: Math.round(summaries.reduce((s, x) => s + x.stages[i].loots, 0) / n),
                    battles: Math.round(summaries.reduce((s, x) => s + x.stages[i].battles, 0) / n),
                    defeats: Math.round(summaries.reduce((s, x) => s + x.stages[i].defeats, 0) / n)
                }))
            };

            return avg;
        }

        function renderLayers(results) {
            const container = document.getElementById('layers-container');
            container.innerHTML = '';

            const baseline = results[0].summary;
            const showRarity = document.getElementById('showRarity').checked;

            results.forEach((result, index) => {
                const layer = document.createElement('div');
                layer.className = 'layer';

                const diff = index > 0 ? calculateDiff(baseline, result.summary) : null;

                layer.innerHTML = `
                    <h3>Layer ${index}: ${result.name}</h3>
                    <div class="layer-summary">
                        <div class="summary-item">
                            <div class="summary-value">${result.summary.totalLoots}${diff ? formatDiff(diff.loots) : ''}</div>
                            <div class="summary-label">Total Loots</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${result.summary.totalDefeats}${diff ? formatDiff(diff.defeats) : ''}</div>
                            <div class="summary-label">Defeats</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${result.summary.finalLampLevel}</div>
                            <div class="summary-label">Lamp Level</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${formatPower(result.summary.finalHeroPower)}</div>
                            <div class="summary-label">Hero Power</div>
                        </div>
                    </div>
                    <div class="charts-row">
                        <div class="chart-container">
                            <h4>Loots per Stage & Guaranteed Upgrade Interval</h4>
                            <div class="chart-scroll">
                                <canvas id="loots-stage-${index}" width="600" height="250"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h4>Loots per Chapter</h4>
                            <canvas id="loots-chapter-${index}" width="600" height="250"></canvas>
                        </div>
                    </div>
                `;
                container.appendChild(layer);

                // Render charts after DOM is updated
                setTimeout(() => {
                    renderLootsChart(
                        document.getElementById(`loots-stage-${index}`),
                        result.summary.stages
                    );
                    renderLootsChapterChart(
                        document.getElementById(`loots-chapter-${index}`),
                        result.summary.chapters,
                        result.summary.stages,
                        { showRarity }
                    );
                }, 0);
            });
        }

        function calculateDiff(baseline, current) {
            return {
                loots: current.totalLoots - baseline.totalLoots,
                defeats: current.totalDefeats - baseline.totalDefeats
            };
        }

        function formatDiff(value) {
            if (value === 0) return '';
            const cls = value > 0 ? 'diff-positive' : 'diff-negative';
            const sign = value > 0 ? '+' : '';
            return `<span class="summary-diff ${cls}">(${sign}${value})</span>`;
        }

        function formatPower(value) {
            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
            if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
            return value.toString();
        }

        // ===== Chart Rendering Functions =====

        function renderLootsChart(canvas, stages) {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const padding = { top: 30, right: 80, bottom: 50, left: 80 };
            const minBarWidth = 2;
            const minCanvasWidth = 600;

            const neededWidth = padding.left + padding.right + stages.length * minBarWidth;
            canvas.width = Math.max(minCanvasWidth, neededWidth);

            const width = canvas.width - padding.left - padding.right;
            const height = canvas.height - padding.top - padding.bottom;

            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const loots = stages.map(s => s.loots);
            const everyNValues = stages.map(s => s.guaranteedEveryN || 0);
            const totalDropsValues = stages.map(s => s.totalDrops || 0);
            const maxLoots = Math.max(...loots, 1);
            const maxEveryN = Math.max(...everyNValues, ...totalDropsValues, 10);

            const barWidth = width / stages.length;

            // Draw loots bars
            for (let i = 0; i < stages.length; i++) {
                const x = padding.left + i * barWidth;
                const barHeight = (loots[i] / maxLoots) * height;
                const y = padding.top + height - barHeight;

                ctx.fillStyle = loots[i] > 0 ? '#6bff6b' : '#333';
                ctx.fillRect(x, y, barWidth - 1, barHeight);
            }

            // Check if lines should be drawn (not all zeros)
            const hasEveryN = everyNValues.some(v => v > 0);
            const hasTotalDrops = totalDropsValues.some(v => v > 0);

            const yScaleEveryN = (v) => padding.top + height - (v / maxEveryN) * height;
            const xScale = (i) => padding.left + i * barWidth + barWidth / 2;

            // Fill area under EveryN line (only if has values)
            if (hasEveryN) {
                ctx.beginPath();
                ctx.moveTo(xScale(0), padding.top + height);
                for (let i = 0; i < stages.length; i++) {
                    ctx.lineTo(xScale(i), yScaleEveryN(everyNValues[i]));
                }
                ctx.lineTo(xScale(stages.length - 1), padding.top + height);
                ctx.closePath();
                ctx.fillStyle = '#ffd70022';
                ctx.fill();
            }

            // EveryN line (only if has values)
            if (hasEveryN) {
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < stages.length; i++) {
                    const x = xScale(i);
                    const y = yScaleEveryN(everyNValues[i]);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // TotalDrops line (only if has values)
            if (hasTotalDrops) {
                ctx.strokeStyle = '#22d3ee';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < stages.length; i++) {
                    const x = xScale(i);
                    const y = yScaleEveryN(totalDropsValues[i]);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // Left Y label (Loots)
            ctx.fillStyle = '#6bff6b';
            ctx.font = '12px Courier New';
            ctx.textAlign = 'right';
            ctx.fillText(maxLoots.toString(), padding.left - 10, padding.top + 4);
            ctx.fillText('0', padding.left - 10, padding.top + height + 4);

            // Right Y label (EveryN) - only if has lines
            if (hasEveryN || hasTotalDrops) {
                ctx.fillStyle = '#ffd700';
                ctx.textAlign = 'left';
                ctx.fillText(maxEveryN.toString(), padding.left + width + 10, padding.top + 4);
                ctx.fillText('0', padding.left + width + 10, padding.top + height + 4);
            }

            // Legend
            ctx.font = '11px Courier New';
            let legendX = padding.left + width - 300;

            ctx.fillStyle = '#6bff6b';
            ctx.fillRect(legendX, padding.top - 20, 12, 12);
            ctx.fillText('Loots', legendX + 15, padding.top - 10);
            legendX += 80;

            if (hasEveryN) {
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(legendX, padding.top - 20, 12, 12);
                ctx.fillText('EveryN', legendX + 15, padding.top - 10);
                legendX += 80;
            }

            if (hasTotalDrops) {
                ctx.fillStyle = '#22d3ee';
                ctx.fillRect(legendX, padding.top - 20, 12, 12);
                ctx.fillText('TotalDrops', legendX + 15, padding.top - 10);
            }
        }

        function renderLootsChapterChart(canvas, chapters, stages, options = {}) {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const showRarity = options.showRarity || false;

            const padding = { top: 30, right: 80, bottom: 50, left: 80 };
            const width = canvas.width - padding.left - padding.right;
            const height = canvas.height - padding.top - padding.bottom;

            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (chapters.length === 0) return;

            const loots = chapters.map(c => c.loots);
            const maxLoots = Math.max(...loots, 1);

            const barWidth = width / chapters.length;

            // Get guaranteed rarity for each chapter (only if showing)
            const chapterRarities = showRarity ? chapters.map(ch => {
                const lastStage = stages.find(s => s.chapter === ch.chapter && s.stage === 10);
                return lastStage?.guaranteedRarity || 'common';
            }) : [];

            for (let i = 0; i < chapters.length; i++) {
                const x = padding.left + i * barWidth;
                const barHeight = (loots[i] / maxLoots) * height;
                const y = padding.top + height - barHeight;

                ctx.fillStyle = '#6bff6b';
                ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
            }

            // Draw Guaranteed Rarity bar at bottom (only if showRarity)
            if (showRarity) {
                const rarityHeight = 10;
                for (let i = 0; i < chapters.length; i++) {
                    const x = padding.left + i * barWidth;
                    const rarity = chapterRarities[i];
                    ctx.fillStyle = RARITY_COLORS[rarity] || '#9ca3af';
                    ctx.fillRect(x + 2, padding.top + height + 2, barWidth - 4, rarityHeight);
                }
            }

            // X labels
            ctx.fillStyle = '#888';
            ctx.font = '11px Courier New';
            ctx.textAlign = 'center';
            for (let i = 0; i < chapters.length; i++) {
                const x = padding.left + i * barWidth + barWidth / 2;
                if (chapters.length <= 30 || i % Math.ceil(chapters.length / 30) === 0) {
                    ctx.fillText(chapters[i].chapter.toString(), x, padding.top + height + 25);
                }
            }

            // Y label
            ctx.textAlign = 'right';
            ctx.fillText(maxLoots.toString(), padding.left - 10, padding.top + 4);
            ctx.fillText('0', padding.left - 10, padding.top + height + 4);

            // Legend for rarity (only when showRarity is enabled)
            if (showRarity) {
                ctx.font = '11px Courier New';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#888';
                ctx.fillText('Rarity', padding.left + width - 60, padding.top - 10);
            }
        }
    </script>
</body>
</html>
